import React, { useState, useEffect, useRef } from 'react';
import { Trash2, ChevronLeft, ZoomIn, Home, Edit3, Palette, Type, CheckSquare, Square, ChevronRight, LayoutGrid, Download, Upload, PieChart, Activity, X, Clock, LogOut } from 'lucide-react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, query, orderBy, serverTimestamp } from 'firebase/firestore';

/**
 * 만다라트 계획표 애플리케이션 (Firebase Import Fixed)
 * * 수정 사항:
 * - Firebase Import 방식 변경: URL Import -> Package Import ('firebase/app', 'firebase/auth' 등)
 * - 환경 호환성 문제 해결
 */

// --- Firebase Configuration & Init ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// 초기 빈 데이터 생성 함수
const createInitialData = () => {
  return Array(9).fill(null).map(() => 
    Array(9).fill(null).map(() => ({ text: '', bg: '', color: '', completed: false }))
  );
};

// --- Sub Components ---

/**
 * 저장된 목록 불러오기 모달
 */
const LoadModal = ({ isOpen, onClose, onLoad, onDelete, saves, isLoading }) => {
  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-[100] flex items-center justify-center px-4">
      <div className="absolute inset-0 bg-black/50 backdrop-blur-sm" onClick={onClose}></div>
      <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md max-h-[80vh] flex flex-col relative z-10 animate-scale-in overflow-hidden">
        <div className="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
          <h3 className="font-bold text-gray-800 flex items-center gap-2">
            <Upload size={18} className="text-rose-500" />
            저장된 계획표 목록
          </h3>
          <button onClick={onClose} className="p-1 hover:bg-gray-200 rounded-full text-gray-400 hover:text-gray-600">
            <X size={20} />
          </button>
        </div>
        
        <div className="overflow-y-auto p-4 flex-1">
          {isLoading ? (
             <div className="flex flex-col items-center justify-center py-10 text-gray-400 gap-2">
               <div className="w-6 h-6 border-2 border-rose-500 border-t-transparent rounded-full animate-spin"></div>
               <span className="text-xs">데이터를 불러오는 중...</span>
             </div>
          ) : saves.length === 0 ? (
            <div className="text-center py-10 text-gray-400 text-sm">
              <p>저장된 계획표가 없습니다.</p>
              <p className="text-xs mt-1 text-gray-300">새로운 계획을 세우고 저장해보세요!</p>
            </div>
          ) : (
            <ul className="space-y-3">
              {saves.map((save) => (
                <li key={save.id} className="bg-white border border-gray-100 rounded-xl p-3 hover:border-rose-300 hover:shadow-md transition-all group relative">
                  <div 
                    onClick={() => onLoad(save)}
                    className="cursor-pointer"
                  >
                    <div className="font-bold text-gray-800 mb-1">{save.title || '제목 없는 목표'}</div>
                    <div className="flex items-center gap-2 text-xs text-gray-400">
                      <Clock size={12} />
                      {save.createdAt ? new Date(save.createdAt.seconds * 1000).toLocaleString() : '날짜 정보 없음'}
                    </div>
                  </div>
                  <button 
                    onClick={(e) => { e.stopPropagation(); onDelete(save.id); }}
                    className="absolute top-3 right-3 p-2 text-gray-300 hover:text-red-500 hover:bg-red-50 rounded-lg opacity-0 group-hover:opacity-100 transition-all"
                    title="삭제"
                  >
                    <Trash2 size={16} />
                  </button>
                </li>
              ))}
            </ul>
          )}
        </div>
      </div>
    </div>
  );
};

/**
 * 홈 화면 (랜딩 페이지 + 통계 + 데이터 관리) 컴포넌트
 */
const HomeView = ({ onStart, savedTitle, gridData, onCloudSave, onOpenLoadModal }) => {
  // 통계 계산
  const stats = React.useMemo(() => {
    let totalGoals = 0;
    let completedGoals = 0;
    
    gridData.forEach(row => {
      row.forEach(cell => {
        if (cell.text && cell.text.trim() !== '') {
          totalGoals++;
          if (cell.completed) completedGoals++;
        }
      });
    });

    const percent = totalGoals === 0 ? 0 : Math.round((completedGoals / totalGoals) * 100);
    return { total: totalGoals, completed: completedGoals, percent };
  }, [gridData]);

  return (
    <div className="flex-1 flex flex-col items-center justify-center w-full max-w-md min-h-[80vh] animate-fade-in px-4 py-8">
      {/* 로고 아이콘 */}
      <div className="mb-6 relative group cursor-default">
        <div className="absolute inset-0 bg-rose-300 rounded-3xl blur-2xl opacity-20 group-hover:opacity-40 transition-opacity duration-500"></div>
        <div className="relative bg-white p-6 rounded-3xl shadow-xl border border-white/50 transform group-hover:scale-105 transition-transform duration-500 flex items-center justify-center">
           <LayoutGrid size={64} className="text-rose-500" strokeWidth={1.5} />
        </div>
      </div>

      {/* 타이틀 */}
      <h1 className="text-3xl md:text-4xl font-bold text-gray-800 mb-2 text-center tracking-tight">
        Mandalart Planner
      </h1>
      <p className="text-gray-400 text-sm mb-8 tracking-widest uppercase">Goal Achievement System</p>

      {/* 통계 대시보드 */}
      {stats.total > 0 ? (
        <div className="w-full bg-white/80 backdrop-blur-sm border border-white p-5 rounded-2xl shadow-sm mb-8 animate-fade-in-up">
          <div className="flex items-center justify-between mb-3">
            <div className="flex items-center gap-2 text-gray-700 font-bold">
              <Activity size={18} className="text-rose-500" />
              <span>현재 달성률</span>
            </div>
            <span className="text-2xl font-bold text-gray-800">{stats.percent}%</span>
          </div>
          
          <div className="w-full h-3 bg-gray-100 rounded-full overflow-hidden mb-3">
            <div 
              className="h-full bg-gradient-to-r from-rose-400 to-rose-600 transition-all duration-1000 ease-out rounded-full" 
              style={{ width: `${stats.percent}%` }}
            ></div>
          </div>
          
          <div className="flex justify-between text-xs text-gray-500">
            <span>총 {stats.total}개의 목표 중</span>
            <span className="font-semibold text-rose-600">{stats.completed}개 완료</span>
          </div>

          {savedTitle && (
             <div className="mt-4 pt-4 border-t border-gray-100 text-center">
               <span className="text-xs text-gray-400 block mb-1">Current Project</span>
               <span className="text-gray-800 font-medium">{savedTitle}</span>
             </div>
          )}
        </div>
      ) : (
        <p className="text-gray-500 text-center mb-10 leading-relaxed max-w-xs text-sm">
          복잡한 머릿속 목표들을<br/>
          <span className="text-rose-500 font-semibold">하나의 지도</span>로 완벽하게 정리하세요.
        </p>
      )}

      {/* 시작 버튼 */}
      <button 
        onClick={onStart}
        className="group w-full max-w-[220px] bg-gray-900 text-white py-4 rounded-2xl font-bold text-lg shadow-lg hover:bg-gray-800 hover:shadow-xl hover:-translate-y-1 transition-all flex items-center justify-center gap-2 mb-12"
      >
        <span>{stats.total > 0 ? '계획 계속하기' : '계획 시작하기'}</span>
        <ChevronRight size={20} className="text-gray-400 group-hover:text-white group-hover:translate-x-1 transition-all" />
      </button>

      {/* 클라우드 저장/불러오기 버튼 */}
      <div className="flex gap-8">
        <button 
          onClick={onCloudSave}
          className="flex flex-col items-center gap-2 text-gray-400 hover:text-rose-500 transition-colors group"
          title="클라우드에 저장"
        >
          <div className="p-3 bg-white rounded-full shadow-sm border border-gray-100 group-hover:border-rose-200 group-hover:shadow-md transition-all">
            <Download size={20} />
          </div>
          <span className="text-xs font-medium">저장하기</span>
        </button>
        
        <button 
          onClick={onOpenLoadModal}
          className="flex flex-col items-center gap-2 text-gray-400 hover:text-rose-500 transition-colors group"
          title="저장된 목록 불러오기"
        >
          <div className="p-3 bg-white rounded-full shadow-sm border border-gray-100 group-hover:border-rose-200 group-hover:shadow-md transition-all">
            <Upload size={20} />
          </div>
          <span className="text-xs font-medium">불러오기</span>
        </button>
      </div>
      
      <footer className="absolute bottom-6 text-gray-300 text-[10px] uppercase tracking-widest opacity-60">
        Syncs with Cloud Storage
      </footer>
    </div>
  );
};

/**
 * 상단 네비게이션 바 컴포넌트
 */
const Header = ({ viewMode, title, setTitle, onGoHome, onReset, onGoLanding, detailTitle }) => (
  <div className="w-full max-w-md flex justify-between items-center mb-6 px-2 gap-4 animate-fade-in-down">
    <div className="flex-1 flex items-center gap-2 overflow-hidden">
      {viewMode === 'DETAIL' && (
        <button 
          onClick={onGoHome}
          className="p-2 -ml-2 text-gray-600 hover:bg-gray-100 rounded-full transition-colors flex items-center gap-1 flex-shrink-0"
        >
          <ChevronLeft size={24} />
        </button>
      )}
      
      {viewMode === 'OVERVIEW' ? (
        <div className="relative w-full group">
            <input
            type="text"
            value={title}
            onChange={(e) => setTitle(e.target.value)}
            className="w-full bg-transparent text-xl font-bold text-gray-800 outline-none border-b-2 border-transparent focus:border-rose-400 transition-colors placeholder:text-gray-300 py-1"
            placeholder="목표 제목 입력"
          />
          <Edit3 size={14} className="absolute right-0 top-1/2 -translate-y-1/2 text-gray-300 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none" />
        </div>
      ) : (
        <h1 className={`text-xl font-bold truncate ${detailTitle ? 'text-gray-800' : 'text-gray-300'}`}>
          {detailTitle || "중간 목표"}
        </h1>
      )}
    </div>
    
    <div className="flex gap-2 flex-shrink-0">
      {viewMode === 'DETAIL' && (
        <button 
          onClick={onGoHome}
          className="p-2 bg-white text-rose-500 rounded-full shadow-sm border border-gray-100 hover:bg-rose-50"
          title="전체 보기"
        >
          <Home size={20} />
        </button>
      )}
      
      {/* 홈 화면으로 돌아가기 버튼 */}
      <button 
        onClick={onGoLanding}
        className="p-2 bg-white text-gray-400 rounded-full shadow-sm border border-gray-100 hover:text-gray-600 hover:bg-gray-50 transition-colors"
        title="홈 화면으로"
      >
        <LogOut size={20} />
      </button>

      <button 
        onClick={onReset}
        className="p-2 bg-white text-gray-400 rounded-full shadow-sm border border-gray-100 hover:text-red-500 hover:bg-red-50 transition-colors"
        title="초기화"
      >
        <Trash2 size={20} />
      </button>
    </div>
  </div>
);

/**
 * 단일 셀 컴포넌트
 */
const Cell = ({ blockIdx, cellIdx, cellData, readOnly = false, onClick, viewMode, onUpdate }) => {
  const [isFocused, setIsFocused] = useState(false);
  const isCenter = cellIdx === 4;
  const isCoreCenter = blockIdx === 4 && cellIdx === 4;
  const containerRef = useRef(null); 
  
  const { text = '', bg = '', color = '', completed = false } = cellData || {};

  const handleBlur = (e) => {
    if (containerRef.current && containerRef.current.contains(e.relatedTarget)) {
      return;
    }
    setIsFocused(false);
  };

  let baseClasses = "w-full h-full p-2 text-center text-sm resize-none outline-none transition-all duration-200 rounded-lg flex items-center justify-center break-keep leading-tight shadow-sm relative group ";
  
  if (readOnly) {
    baseClasses += "cursor-pointer hover:scale-[1.02] hover:shadow-md active:scale-95 select-none ";
  } else if (isFocused) {
    baseClasses += "ring-2 ring-rose-400 z-10 ";
  } else {
    baseClasses += "cursor-text ";
  }

  let defaultBg = "bg-white";
  let defaultText = "text-gray-700";
  let borderClass = "border border-gray-200";

  if (isCoreCenter) {
    defaultBg = "bg-rose-500";
    defaultText = "text-white font-bold text-base";
    borderClass = "border-rose-600 shadow-rose-200";
  } else if (isCenter) {
    const colors = [
      "bg-red-50 text-red-900", 
      "bg-orange-50 text-orange-900", 
      "bg-amber-50 text-amber-900",
      "bg-yellow-50 text-yellow-900", 
      "bg-white", 
      "bg-lime-50 text-lime-900", 
      "bg-green-50 text-green-900", 
      "bg-emerald-50 text-emerald-900", 
      "bg-teal-50 text-teal-900"
    ];
    const colorIndex = viewMode === 'OVERVIEW' ? cellIdx : blockIdx;
    
    const themeClass = colors[colorIndex] || "bg-white text-gray-700";
    
    if (!bg) baseClasses += `${themeClass} `;
    baseClasses += "font-bold ";
    borderClass = `border-${viewMode === 'OVERVIEW' ? 'gray-300' : 'gray-200'}`; 
  } else {
    if (!bg) baseClasses += "bg-white hover:bg-gray-50 text-gray-600 ";
    borderClass = "border-gray-100";
  }

  const completedStyle = completed ? {
    textDecoration: 'line-through',
    opacity: 0.7,
  } : {};

  const customStyle = {
    backgroundColor: bg || undefined,
    color: color || undefined,
    borderColor: bg ? 'transparent' : undefined,
    ...completedStyle
  };

  const placeholderText = isCoreCenter ? "최종 목표" : (isCenter ? "중간 목표" : "");
  const placeholderColorClass = (isCoreCenter || bg) ? "text-white/60 mix-blend-screen" : "text-gray-400 opacity-60";

  const CheckMark = () => completed && (
    <div className="absolute top-1 right-1 text-green-600 bg-white/80 rounded-full shadow-sm p-0.5 z-[5] animate-scale-in">
      <CheckSquare size={12} fill="currentColor" className="text-white" />
    </div>
  );

  if (readOnly) {
    return (
      <div 
        onClick={onClick} 
        className={`${baseClasses} ${borderClass} flex-col gap-1 overflow-hidden`}
        style={customStyle}
      >
        <CheckMark />
        <span className={!text ? placeholderColorClass : ""}>
          {text || "클릭하여 계획하기"}
        </span>
        <div className="absolute right-1 bottom-1 opacity-0 group-hover:opacity-100 transition-opacity text-rose-400 mix-blend-multiply">
          <ZoomIn size={14} />
        </div>
      </div>
    );
  }

  return (
    <div 
      ref={containerRef}
      className={`${baseClasses} ${borderClass}`} 
      style={customStyle}
      onBlur={handleBlur}
    >
      <CheckMark />
      
      {isFocused && (
        <div className="absolute -top-9 left-1/2 -translate-x-1/2 flex gap-1 bg-white p-1 rounded-lg shadow-lg border border-gray-100 animate-fade-in z-30">
          <button
            onClick={() => onUpdate(blockIdx, cellIdx, 'completed', !completed)}
            className={`w-6 h-6 rounded-full hover:scale-110 transition-transform shadow-sm border border-gray-200 flex items-center justify-center ${completed ? 'bg-green-100 text-green-600' : 'bg-gray-50 text-gray-400'}`}
            title={completed ? "완료 취소" : "완료 표시"}
          >
            {completed ? <CheckSquare size={14} /> : <Square size={14} />}
          </button>

          <div className="w-px bg-gray-200 mx-1"></div>

          <label className="w-6 h-6 rounded-full overflow-hidden cursor-pointer hover:scale-110 transition-transform shadow-sm border border-gray-200 flex items-center justify-center bg-gray-50" title="배경색 변경">
            <Palette size={12} className="text-gray-500" />
            <input 
              type="color" 
              className="absolute opacity-0 w-full h-full cursor-pointer"
              value={bg || '#ffffff'}
              onChange={(e) => onUpdate(blockIdx, cellIdx, 'bg', e.target.value)}
            />
          </label>
          
          <label className="w-6 h-6 rounded-full overflow-hidden cursor-pointer hover:scale-110 transition-transform shadow-sm border border-gray-200 flex items-center justify-center bg-gray-50" title="글자색 변경">
            <Type size={12} className="text-gray-500" />
            <input 
              type="color" 
              className="absolute opacity-0 w-full h-full cursor-pointer"
              value={color || '#000000'}
              onChange={(e) => onUpdate(blockIdx, cellIdx, 'color', e.target.value)}
            />
          </label>

          {(bg || color) && (
            <button 
              onClick={() => {
                onUpdate(blockIdx, cellIdx, 'bg', '');
                onUpdate(blockIdx, cellIdx, 'color', '');
              }}
              className="w-6 h-6 rounded-full hover:bg-red-50 text-red-400 flex items-center justify-center transition-colors"
              title="색상 초기화"
            >
              <Trash2 size={12} />
            </button>
          )}
        </div>
      )}

      {!isFocused ? (
        <div 
          onClick={() => setIsFocused(true)}
          className="w-full h-full flex items-center justify-center cursor-text"
        >
          {text ? (
            <span className="whitespace-pre-wrap break-words w-full">{text}</span>
          ) : (
            <span className={placeholderColorClass}>{placeholderText}</span>
          )}
        </div>
      ) : (
        <textarea
          autoFocus
          ref={(ref) => {
             if (ref) {
               ref.style.height = 'auto';
               ref.style.height = ref.scrollHeight + 'px';
             }
          }}
          className="w-full bg-transparent text-center resize-none outline-none overflow-hidden block p-0 m-0 leading-tight z-10"
          style={{ maxHeight: '100%' }}
          value={text}
          onChange={(e) => {
               e.target.style.height = 'auto';
               e.target.style.height = e.target.scrollHeight + 'px';
               onUpdate(blockIdx, cellIdx, 'text', e.target.value);
          }}
          onFocus={(e) => {
            const val = e.target.value;
            e.target.value = '';
            e.target.value = val;
          }}
          placeholder={placeholderText}
          spellCheck="false"
          rows={1}
        />
      )}
    </div>
  );
};

/**
 * 3x3 그리드 레이아웃 컴포넌트
 */
const GridBlock = ({ viewMode, activeBlock, gridData, onUpdate, onNavigate }) => {
  const targetBlockIdx = viewMode === 'OVERVIEW' ? 4 : activeBlock;
  const currentCells = gridData[targetBlockIdx];

  return (
    <div className="w-full max-w-md aspect-square animate-fade-in">
      <div className="grid grid-cols-3 gap-2 h-full">
        {currentCells.map((cellData, cellIdx) => {
          if (viewMode === 'OVERVIEW') {
            if (cellIdx === 4) {
              return (
                <Cell 
                  key={`ov-core-${cellIdx}`}
                  blockIdx={4} 
                  cellIdx={4} 
                  cellData={cellData}
                  viewMode={viewMode}
                  onUpdate={onUpdate}
                />
              );
            }
            return (
              <Cell 
                key={`ov-nav-${cellIdx}`}
                blockIdx={4} 
                cellIdx={cellIdx} 
                cellData={cellData}
                readOnly={true}
                viewMode={viewMode}
                onClick={() => onNavigate(cellIdx)}
              />
            );
          }

          return (
            <Cell 
              key={`dt-${targetBlockIdx}-${cellIdx}`}
              blockIdx={targetBlockIdx} 
              cellIdx={cellIdx} 
              cellData={cellData}
              viewMode={viewMode}
              onUpdate={onUpdate}
            />
          );
        })}
      </div>
    </div>
  );
};

// --- Main App Component ---

const MandalartApp = () => {
  const [gridData, setGridData] = useState(createInitialData);
  const [title, setTitle] = useState('');
  const [viewMode, setViewMode] = useState('HOME');
  const [activeBlock, setActiveBlock] = useState(4);
  const [notification, setNotification] = useState('');
  
  // Firebase Auth State
  const [user, setUser] = useState(null);
  
  // Load Modal State
  const [isLoadModalOpen, setIsLoadModalOpen] = useState(false);
  const [savedLists, setSavedLists] = useState([]);
  const [isLoadingSaves, setIsLoadingSaves] = useState(false);

  // --- Auth Init ---
  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  // --- LocalStorage Logic (Active Session Only) ---
  useEffect(() => {
    const savedData = localStorage.getItem('mandalart-data');
    if (savedData) {
      try {
        const parsed = JSON.parse(savedData);
        if (parsed.length > 0) {
          if (typeof parsed[0][0] === 'string') {
             const migrated = parsed.map(row => 
               row.map(text => ({ text, bg: '', color: '', completed: false }))
             );
             setGridData(migrated);
             return;
          }
          if (parsed[0][0].completed === undefined) {
             const migrated = parsed.map(row => 
               row.map(cell => ({ ...cell, completed: false }))
             );
             setGridData(migrated);
             return;
          }
          setGridData(parsed);
        }
      } catch (e) {
        console.error("데이터 로드 실패:", e);
      }
    }
    const savedTitle = localStorage.getItem('mandalart-title');
    if (savedTitle) setTitle(savedTitle);
  }, []);

  useEffect(() => {
    localStorage.setItem('mandalart-data', JSON.stringify(gridData));
  }, [gridData]);

  useEffect(() => {
    localStorage.setItem('mandalart-title', title);
  }, [title]);

  const handleUpdate = (blockIdx, cellIdx, field, value) => {
    const newData = [...gridData.map(row => [...row])]; 
    newData[blockIdx][cellIdx] = { ...newData[blockIdx][cellIdx], [field]: value };

    // 동기화 로직
    if (blockIdx === 4 && cellIdx !== 4) {
      newData[cellIdx][4] = { ...newData[cellIdx][4], [field]: value };
    } else if (blockIdx !== 4 && cellIdx === 4) {
      newData[4][blockIdx] = { ...newData[4][blockIdx], [field]: value };
    }

    setGridData(newData);
  };

  const handleReset = () => {
    if (window.confirm('모든 계획이 삭제됩니다. 초기화하시겠습니까?')) {
      setGridData(createInitialData());
      setTitle('');
      setViewMode('HOME'); 
      setActiveBlock(4);
      showNotification('초기화되었습니다.');
    }
  };

  const showNotification = (msg) => {
    setNotification(msg);
    setTimeout(() => setNotification(''), 2000);
  };

  // --- Cloud Storage Handlers ---

  const handleCloudSave = async () => {
    if (!user) {
      showNotification('로그인이 필요합니다.');
      return;
    }
    try {
      showNotification('저장 중입니다...');
      const savesRef = collection(db, 'artifacts', appId, 'users', user.uid, 'mandalarts');
      await addDoc(savesRef, {
        title: title || '제목 없음',
        gridData: JSON.stringify(gridData),
        createdAt: serverTimestamp(),
        version: 1
      });
      showNotification('클라우드에 저장되었습니다!');
    } catch (error) {
      console.error("Save Error:", error);
      showNotification('저장에 실패했습니다.');
    }
  };

  const fetchCloudSaves = async () => {
    if (!user) return;
    setIsLoadingSaves(true);
    try {
      const savesRef = collection(db, 'artifacts', appId, 'users', user.uid, 'mandalarts');
      const q = query(savesRef); 
      const querySnapshot = await getDocs(q);
      
      const loadedSaves = querySnapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));

      loadedSaves.sort((a, b) => {
         const timeA = a.createdAt?.seconds || 0;
         const timeB = b.createdAt?.seconds || 0;
         return timeB - timeA; 
      });

      setSavedLists(loadedSaves);
      setIsLoadModalOpen(true);
    } catch (error) {
      console.error("Fetch Error:", error);
      showNotification('목록을 불러오지 못했습니다.');
    } finally {
      setIsLoadingSaves(false);
    }
  };

  const handleLoadSave = (saveData) => {
    try {
      const parsedGrid = JSON.parse(saveData.gridData);
      setGridData(parsedGrid);
      setTitle(saveData.title || '');
      setIsLoadModalOpen(false);
      showNotification('계획표를 불러왔습니다.');
      setViewMode('OVERVIEW');
    } catch (e) {
      showNotification('데이터 형식이 올바르지 않습니다.');
    }
  };

  const handleDeleteSave = async (docId) => {
    if (!window.confirm('정말 삭제하시겠습니까?')) return;
    try {
      await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'mandalarts', docId));
      setSavedLists(prev => prev.filter(item => item.id !== docId));
      showNotification('삭제되었습니다.');
    } catch (error) {
      showNotification('삭제 실패');
    }
  };

  const goToDetail = (blockIdx) => {
    setActiveBlock(blockIdx);
    setViewMode('DETAIL');
  };

  const goHome = () => {
    setActiveBlock(4);
    setViewMode('OVERVIEW');
  };

  const goLanding = () => {
    setViewMode('HOME');
  };

  const currentDetailTitle = gridData[activeBlock][4]?.text;

  return (
    <div className="min-h-screen bg-sky-50 flex flex-col items-center py-8 px-4 font-sans selection:bg-rose-100 transition-colors duration-500">
      
      <LoadModal 
        isOpen={isLoadModalOpen} 
        onClose={() => setIsLoadModalOpen(false)}
        onLoad={handleLoadSave}
        onDelete={handleDeleteSave}
        saves={savedLists}
        isLoading={isLoadingSaves}
      />

      {viewMode === 'HOME' ? (
        // 홈 화면 (Landing Page)
        <HomeView 
          onStart={() => setViewMode('OVERVIEW')} 
          savedTitle={title}
          gridData={gridData}
          onCloudSave={handleCloudSave}
          onOpenLoadModal={fetchCloudSaves}
        />
      ) : (
        // 메인 앱 화면 (Header + Grid)
        <>
          <Header 
            viewMode={viewMode}
            title={title}
            setTitle={setTitle}
            onGoHome={goHome}
            onReset={handleReset}
            onGoLanding={goLanding}
            detailTitle={currentDetailTitle}
          />

          <GridBlock 
            viewMode={viewMode}
            activeBlock={activeBlock}
            gridData={gridData}
            onUpdate={handleUpdate}
            onNavigate={goToDetail}
          />
        </>
      )}

      {notification && (
        <div className="fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-gray-800/90 text-white px-4 py-2 rounded-full text-sm shadow-xl backdrop-blur-sm animate-fade-in-up z-[200]">
          {notification}
        </div>
      )}
    </div>
  );
};

export default MandalartApp;